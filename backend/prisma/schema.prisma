// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MANAGEMENT
// ============================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  username  String   @unique
  password  String

  // Profile
  displayName String?
  avatar      String?
  bio         String?

  // Gamification Stats
  level       Int      @default(1)
  xp          Int      @default(0)
  health      Int      @default(50)
  maxHealth   Int      @default(50)
  gold        Int      @default(0)
  gems        Int      @default(0)

  // Attributes (RPG-style)
  strength     Int @default(0)
  intelligence Int @default(0)
  constitution Int @default(0)
  perception   Int @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastActive DateTime @default(now())

  // Relations
  habits                Habit[]
  dailyTasks            DailyTask[]
  completions           HabitCompletion[]
  userQuests            UserQuest[]
  achievements          UserAchievement[]
  streakHistory         StreakHistory[]
  householdMembers      HouseholdMember[]
  ownedHouseholds       Household[]               @relation("HouseholdOwner")
  requestedFavors       FavorTransaction[]        @relation("RequestedFavors")
  assignedFavors        FavorTransaction[]        @relation("AssignedFavors")
  choreAssignments      ChoreAssignment[]
  announcements         Announcement[]
  announcementReactions AnnouncementReaction[]

  @@map("users")
}

// ============================================
// HABIT TRACKING
// ============================================

enum HabitType {
  POSITIVE  // Good habits to build (e.g., exercise, study)
  NEGATIVE  // Bad habits to break (e.g., smoking, procrastination)
  DAILY     // Daily tasks/chores
}

enum HabitFrequency {
  DAILY
  WEEKLY
  CUSTOM
}

model Habit {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Habit Details
  title       String
  description String?
  icon        String?
  color       String?

  // Type & Settings
  type        HabitType        @default(POSITIVE)
  frequency   HabitFrequency   @default(DAILY)
  difficulty  Int              @default(1) // 1-5 (affects XP rewards)

  // Rewards
  xpReward    Int              @default(10)
  goldReward  Int              @default(5)
  healthCost  Int              @default(0) // For negative habits

  // Tracking
  currentStreak Int            @default(0)
  longestStreak Int            @default(0)
  totalCompletions Int         @default(0)

  // Schedule
  isActive    Boolean          @default(true)
  startDate   DateTime         @default(now())
  endDate     DateTime?

  // Timestamps
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  // Relations
  completions HabitCompletion[]

  @@map("habits")
  @@index([userId])
}

model HabitCompletion {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  habitId     String
  habit       Habit    @relation(fields: [habitId], references: [id], onDelete: Cascade)

  // Completion Details
  completedAt DateTime @default(now())
  date        DateTime @default(now()) @db.Date
  notes       String?

  // Rewards Earned
  xpEarned    Int      @default(0)
  goldEarned  Int      @default(0)

  @@map("habit_completions")
  @@unique([habitId, date])
  @@index([userId])
  @@index([date])
}

// ============================================
// DAILY TASKS
// ============================================

model DailyTask {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Task Details
  title       String
  description String?

  // Completion
  isCompleted Boolean  @default(false)
  completedAt DateTime?
  dueDate     DateTime @db.Date

  // Rewards
  xpReward    Int      @default(5)
  goldReward  Int      @default(2)

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("daily_tasks")
  @@index([userId])
  @@index([dueDate])
}

// ============================================
// DAILY QUESTS
// ============================================

enum QuestType {
  HABIT_COMPLETION    // Complete X habits
  STREAK_BUILD        // Build/maintain streak
  SPECIFIC_HABIT      // Complete specific habit
  SOCIAL              // Help family member
  CUSTOM              // Custom requirements
}

model Quest {
  id          String    @id @default(uuid())

  // Quest Details
  key         String    @unique // e.g., "complete_3_habits", "maintain_streak"
  title       String
  description String
  icon        String?

  // Quest Type & Requirements
  type        QuestType
  category    String    @default("daily") // "daily", "weekly", "special"
  targetCount Int       @default(1)       // How many to complete

  // Rewards
  xpReward    Int       @default(20)
  goldReward  Int       @default(10)
  gemsReward  Int       @default(0)

  // Settings
  isActive    Boolean   @default(true)
  isDaily     Boolean   @default(true)
  difficulty  Int       @default(1)       // 1-3 (easy, medium, hard)

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  userQuests  UserQuest[]

  @@map("quests")
}

model UserQuest {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  questId     String
  quest       Quest    @relation(fields: [questId], references: [id], onDelete: Cascade)

  // Progress
  progress    Int      @default(0)
  isCompleted Boolean  @default(false)
  completedAt DateTime?

  // Daily reset tracking
  assignedDate DateTime @db.Date
  expiresAt    DateTime

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("user_quests")
  @@unique([userId, questId, assignedDate])
  @@index([userId])
  @@index([assignedDate])
  @@index([isCompleted])
}

// ============================================
// GAMIFICATION
// ============================================

model Achievement {
  id          String   @id @default(uuid())

  // Achievement Details
  key         String   @unique // e.g., "first_habit", "streak_7", "level_10"
  name        String
  description String
  icon        String?

  // Requirements
  category    String   // e.g., "habits", "streaks", "levels"
  requirement Int      // e.g., 7 for streak_7

  // Rewards
  xpReward    Int      @default(0)
  goldReward  Int      @default(0)
  gemsReward  Int      @default(0)

  // Timestamps
  createdAt   DateTime @default(now())

  // Relations
  users       UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id            String      @id @default(uuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievementId String
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  // Unlock Details
  unlockedAt    DateTime    @default(now())
  progress      Int         @default(0)

  @@map("user_achievements")
  @@unique([userId, achievementId])
  @@index([userId])
}

model StreakHistory {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Streak Details
  date        DateTime @db.Date
  streakCount Int

  @@map("streak_history")
  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

// ============================================
// HOUSEHOLD / FAMILY
// ============================================

enum HouseholdRole {
  OWNER
  ADMIN
  MEMBER
}

model Household {
  id          String   @id @default(uuid())
  
  // Household Details
  name        String
  description String?
  avatar      String?
  inviteCode  String   @unique @default(uuid())
  
  // Settings
  isActive    Boolean  @default(true)
  maxMembers  Int      @default(10)
  
  // Owner
  ownerId     String
  owner       User     @relation("HouseholdOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  members        HouseholdMember[]
  transactions   FavorTransaction[]
  choreTemplates ChoreTemplate[]
  announcements  Announcement[]

  @@map("households")
  @@index([ownerId])
  @@index([inviteCode])
}

model HouseholdMember {
  id           String        @id @default(uuid())
  householdId  String
  household    Household     @relation(fields: [householdId], references: [id], onDelete: Cascade)
  userId       String
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Member Details
  role         HouseholdRole @default(MEMBER)
  nickname     String?
  
  // Stats
  contribution Int           @default(0) // Total contribution points
  
  // Timestamps
  joinedAt     DateTime      @default(now())
  
  @@map("household_members")
  @@unique([householdId, userId])
  @@index([householdId])
  @@index([userId])
}

// ============================================
// LETS (Local Exchange Trade System)
// ============================================

enum TransactionStatus {
  PENDING
  ACCEPTED
  COMPLETED
  DECLINED
  CANCELLED
}

model FavorTransaction {
  id             String            @id @default(uuid())
  householdId    String
  household      Household         @relation(fields: [householdId], references: [id], onDelete: Cascade)
  
  // Who needs the favor
  requesterId    String
  requester      User              @relation("RequestedFavors", fields: [requesterId], references: [id], onDelete: Cascade)
  
  // Who will do the favor (can be null for open requests)
  assigneeId     String?
  assignee       User?             @relation("AssignedFavors", fields: [assigneeId], references: [id], onDelete: Cascade)
  
  // Task Details
  title          String
  description    String?
  credits        Int               @default(10) // Favor credits for this task
  
  // Status
  status         TransactionStatus @default(PENDING)
  
  // Timestamps
  createdAt      DateTime          @default(now())
  acceptedAt     DateTime?
  completedAt    DateTime?
  
  @@map("favor_transactions")
  @@index([householdId])
  @@index([requesterId])
  @@index([assigneeId])
  @@index([status])
}

// ============================================
// CHORE ROTATION SYSTEM
// ============================================

enum ChoreFrequency {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
}

model ChoreTemplate {
  id            String        @id @default(uuid())
  householdId   String
  household     Household     @relation(fields: [householdId], references: [id], onDelete: Cascade)

  // Chore Details
  title         String
  description   String?
  icon          String?       @default("üßπ")

  // Difficulty & Time
  difficulty    Int           @default(1)      // 1-5
  estimatedTime Int?                           // minutes

  // Rewards
  xpReward      Int           @default(20)
  goldReward    Int           @default(10)
  letsCredit    Int           @default(5)      // LETS credits for completion

  // Settings
  frequency     ChoreFrequency @default(WEEKLY)
  photoRequired Boolean       @default(false)
  isActive      Boolean       @default(true)

  // Timestamps
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  assignments   ChoreAssignment[]

  @@map("chore_templates")
  @@index([householdId])
}

model ChoreAssignment {
  id           String        @id @default(uuid())
  choreId      String
  chore        ChoreTemplate @relation(fields: [choreId], references: [id], onDelete: Cascade)
  assignedTo   String
  user         User          @relation(fields: [assignedTo], references: [id], onDelete: Cascade)

  // Assignment Period
  weekStarting DateTime      @db.Date

  // Completion
  isCompleted  Boolean       @default(false)
  completedAt  DateTime?
  photoUrl     String?
  notes        String?

  // Swapping
  swappedWith  String?                        // User ID if chore was swapped
  swapRequested Boolean      @default(false)

  // Timestamps
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@map("chore_assignments")
  @@unique([choreId, weekStarting, assignedTo])
  @@index([assignedTo])
  @@index([weekStarting])
  @@index([isCompleted])
}

// ============================================
// HOUSE BULLETIN BOARD
// ============================================

enum AnnouncementType {
  INFO
  URGENT
  EVENT
  REMINDER
  POLL
}

model Announcement {
  id          String   @id @default(uuid())
  householdId String
  household   Household @relation(fields: [householdId], references: [id], onDelete: Cascade)
  authorId    String
  author      User     @relation(fields: [authorId], references: [id], onDelete: Cascade)

  // Announcement Details
  title       String
  content     String
  type        AnnouncementType @default(INFO)
  isPinned    Boolean  @default(false)
  expiresAt   DateTime?

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  reactions   AnnouncementReaction[]

  @@map("announcements")
  @@index([householdId])
  @@index([authorId])
  @@index([isPinned])
  @@index([type])
}

model AnnouncementReaction {
  id             String   @id @default(uuid())
  announcementId String
  announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Reaction
  emoji          String   // üëç ‚ù§Ô∏è üòÇ üòÆ üò¢ üéâ

  // Timestamp
  createdAt      DateTime @default(now())

  @@map("announcement_reactions")
  @@unique([announcementId, userId, emoji])
  @@index([announcementId])
  @@index([userId])
}
